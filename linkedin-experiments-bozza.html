<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkedIn Experiments - Build in Public</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      /* Primary Colors */
      --primary-dark: #0A0A0A;
      --primary-light: #F5F5F0;
      --accent-black: #1A1A1A;
      
      /* Text Colors */
      --text-primary: #2D2D2D;
      --text-secondary: #6B6B6B;
      --text-tertiary: #999999;
      
      /* Border Colors */
      --border-light: #E5E5E0;
      --border-medium: #D0D0CB;
      
      /* Accent Colors */
      --success-green: #10B981;
      --warning-amber: #F59E0B;
      --info-blue: #3B82F6;
      --error-red: #EF4444;
      
      /* Neutrals */
      --gray-50: #FAFAF9;
      --gray-100: #F5F5F0;
      --gray-200: #E8E8E3;
      --gray-300: #D1D1CC;
      --gray-400: #A3A3A0;
      --gray-500: #737371;
      --gray-600: #525250;
      --gray-700: #404040;
      --gray-800: #2A2A2A;
      --gray-900: #1A1A1A;
      
      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      
      /* Component Sizes */
      --sidebar-width: 280px;
      --topbar-height: 80px;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      
      /* Transitions */
      --transition-base: 0.2s ease;
      
      /* Typography */
      --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --text-xs: 11px;
      --text-sm: 13px;
      --text-base: 15px;
      --text-lg: 17px;
      --text-xl: 20px;
      --text-2xl: 28px;
      --text-3xl: 40px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-primary);
      background: var(--primary-dark);
      color: var(--text-primary);
      overflow: hidden;
    }
    
    .app-container {
      display: flex;
      height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--primary-light);
      padding: var(--space-6) var(--space-4);
      overflow-y: auto;
      border-right: 1px solid var(--border-light);
    }
    
    .sidebar-header {
      margin-bottom: var(--space-8);
    }
    
    .sidebar-title {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }
    
    .sidebar-subtitle {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: 10px var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: background var(--transition-base);
      text-decoration: none;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }
    
    .sidebar-nav-item:hover {
      background: var(--gray-200);
    }
    
    .sidebar-nav-item.active {
      background: var(--gray-200);
      color: var(--text-primary);
    }
    
    .sidebar-nav-item__icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    
    .sidebar-nav-item__badge {
      margin-left: auto;
      background: var(--gray-300);
      color: var(--text-secondary);
      font-size: var(--text-xs);
      font-weight: 500;
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .topbar {
      height: var(--topbar-height);
      background: var(--primary-light);
      padding: 0 var(--space-8);
      display: flex;
      align-items: center;
      gap: var(--space-6);
      border-bottom: 1px solid var(--border-light);
    }
    
    .topbar-title {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .topbar-description {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-left: auto;
    }
    
    .dashboard-content {
      flex: 1;
      padding: var(--space-8);
      overflow-y: auto;
      background: var(--gray-100);
    }
    
    /* Experiment Cards */
    .experiments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: var(--space-5);
    }
    
    .experiment-card {
      background: var(--primary-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      cursor: pointer;
      transition: all var(--transition-base);
    }
    
    .experiment-card:hover {
      border-color: var(--gray-300);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .experiment-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
    }
    
    .experiment-card__date {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .experiment-card__category {
      display: inline-block;
      background: var(--gray-200);
      color: var(--text-secondary);
      font-size: var(--text-xs);
      font-weight: 600;
      padding: 4px var(--space-3);
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .experiment-card__validation-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .experiment-card__validation {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: var(--text-xs);
      font-weight: 600;
      padding: 4px var(--space-3);
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: help;
    }
    
    .experiment-card__validation--positive {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success-green);
    }
    
    .experiment-card__validation--negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error-red);
    }
    
    .experiment-card__validation--neutral {
      background: var(--gray-200);
      color: var(--text-secondary);
    }
    
    .validation-info-icon {
      font-size: 12px;
      opacity: 0.7;
      font-weight: 600;
    }
    
    .validation-tooltip {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--accent-black);
      color: var(--primary-light);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      min-width: 280px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      pointer-events: none;
    }
    
    .experiment-card__validation-wrapper:hover .validation-tooltip {
      opacity: 1;
      visibility: visible;
    }
    
    .growth-breakdown {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .growth-breakdown__title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-400);
      margin-bottom: var(--space-2);
    }
    
    .growth-breakdown__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: var(--text-sm);
      gap: var(--space-3);
    }
    
    .growth-breakdown__label {
      color: var(--gray-300);
      flex: 1;
    }
    
    .growth-breakdown__value {
      font-weight: 600;
      color: var(--primary-light);
      min-width: 50px;
      text-align: right;
    }
    
    .growth-breakdown__weight {
      color: var(--gray-500);
      font-size: var(--text-xs);
      min-width: 50px;
      text-align: right;
    }
    
    .experiment-card__section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: var(--space-4);
      margin-bottom: var(--space-2);
    }
    
    .experiment-card__hypothesis {
      font-size: var(--text-base);
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.5;
      margin-bottom: var(--space-3);
    }
    
    .experiment-card__learning {
      font-size: var(--text-base);
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: var(--space-5);
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .metric-item {
      background: var(--gray-50);
      padding: var(--space-3);
      border-radius: var(--radius-md);
    }
    
    .metric-item__label {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      margin-bottom: var(--space-1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-item__value {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
    }
    
    .metric-item__number {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .metric-item__change {
      font-size: var(--text-sm);
      font-weight: 600;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
    }
    
    .metric-item__change--positive {
      color: var(--success-green);
      background: rgba(16, 185, 129, 0.1);
    }
    
    .metric-item__change--negative {
      color: var(--error-red);
      background: rgba(239, 68, 68, 0.1);
    }
    
    .metric-item__change--neutral {
      color: var(--text-tertiary);
      background: var(--gray-200);
    }
    
    /* Stats Cards (for Metriche tab) */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-5);
      margin-bottom: var(--space-8);
    }
    
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .stats-card {
      background: var(--primary-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      border: 1px solid var(--border-light);
    }
    
    .stats-card__label {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-2);
    }
    
    .stats-card__value {
      font-size: var(--text-3xl);
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }
    
    .stats-card__sublabel {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      margin-top: var(--space-1);
    }
    
    /* Charts */
    .chart-container {
      background: var(--primary-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      border: 1px solid var(--border-light);
      margin-bottom: var(--space-5);
    }
    
    .chart-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-5);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: var(--text-lg);
      color: var(--text-secondary);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--text-secondary);
    }
    
    .empty-state__title {
      font-size: var(--text-xl);
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--text-primary);
    }
    
    /* Data Table Styles */
    .data-table-container {
      background: var(--primary-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    
    .data-table-wrapper {
      overflow-x: auto;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-sm);
    }
    
    .data-table thead {
      position: sticky;
      top: 0;
      background: var(--gray-100);
      z-index: 10;
    }
    
    .data-table th {
      padding: var(--space-3) var(--space-4);
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border-light);
      white-space: nowrap;
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .data-table tbody tr {
      border-bottom: 1px solid var(--border-light);
      transition: background-color 0.2s ease;
    }
    
    .data-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    .data-table tbody tr.summary-row {
      background: var(--gray-100);
      font-weight: 700;
    }
    
    .data-table tbody tr.summary-row:hover {
      background: var(--gray-100);
    }
    
    .data-table td {
      padding: var(--space-3) var(--space-4);
      color: var(--text-primary);
      white-space: nowrap;
    }
    
    .data-table td.number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-title">Weekly LinkedIn Experiments</h1>
        <p class="sidebar-subtitle">Cresci su LinkedIn imparando dagli errori di <a href="https://www.marcofantozzi.it" target="_blank" rel="noopener noreferrer" style="color: var(--text-primary); text-decoration: underline; font-weight: 500;">Marco Fantozzi</a></p>
      </div>
      
      <nav class="sidebar-nav">
        <button class="sidebar-nav-item active" data-tab="dati">
          <svg class="sidebar-nav-item__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Dati</span>
        </button>
        
        <button class="sidebar-nav-item" data-tab="sintesi">
          <svg class="sidebar-nav-item__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <span>Sintesi</span>
        </button>
        
        <button class="sidebar-nav-item" data-tab="esperimenti">
          <svg class="sidebar-nav-item__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <span>Esperimenti</span>
          <span class="sidebar-nav-item__badge" id="experiments-count">0</span>
        </button>
        
        <button class="sidebar-nav-item" data-tab="trend">
          <svg class="sidebar-nav-item__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
          </svg>
          <span>Trend</span>
        </button>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <header class="topbar">
        <h2 class="topbar-title" id="topbar-title">Dati</h2>
        <p class="topbar-description">Aggiornato in tempo reale dal Google Sheet</p>
      </header>
      
      <div class="dashboard-content">
        <!-- Dati Tab -->
        <div id="tab-dati" class="tab-content active">
          <div class="loading">Caricamento dati...</div>
        </div>
        
        <!-- Sintesi Tab -->
        <div id="tab-sintesi" class="tab-content">
          <div class="loading">Caricamento sintesi...</div>
        </div>
        
        <!-- Esperimenti Tab -->
        <div id="tab-esperimenti" class="tab-content">
          <div class="loading">Caricamento esperimenti...</div>
        </div>
        
        <!-- Trend Tab -->
        <div id="tab-trend" class="tab-content">
          <div class="loading">Caricamento trend...</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Google Sheet CSV URL
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTAUnGecgnXSIbO1cUCtrFFwWLMXX9N24QiJIG8BU6rdl3B8-CZ0zO5CKFa_hjGPeIJD2Cbt4qQfmeC/pub?gid=0&single=true&output=csv';
    
    let experimentsData = [];
    
    // Parse CSV
    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',');
      
      return lines.slice(1).map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let char of line) {
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        
        const obj = {};
        headers.forEach((header, i) => {
          obj[header.trim()] = values[i] || '';
        });
        return obj;
      });
    }
    
    // Calculate percentage change vs all previous weeks average
    // Note: data is ordered from most recent (index 0) to oldest
    function calculateChange(currentValue, data, index, metricKey) {
      // Check if we have any history (need at least 1 week AFTER current index)
      if (index + 1 >= data.length) return null; // No history available
      
      const previousValues = [];
      // Get ALL previous weeks (from index+1 to end)
      for (let i = index + 1; i < data.length; i++) {
        const prevValue = parseFloat(data[i][metricKey]);
        if (!isNaN(prevValue) && prevValue !== 0) {
          previousValues.push(prevValue);
        }
      }
      
      if (previousValues.length === 0) return null;
      
      const average = previousValues.reduce((a, b) => a + b, 0) / previousValues.length;
      if (average === 0) return null;
      
      const change = ((currentValue - average) / average) * 100;
      return Math.round(change);
    }
    
    // Calculate composite growth score
    function calculateGrowthScore(data, index) {
      const exp = data[index];
      
      // Get current values
      const profileViews = parseInt(exp['Profile views 90d']) || 0;
      const engagement = parseInt(exp['Engag.']) || 0;
      const membersReached = parseInt(exp['Members Reached']) || 0;
      const impressions = parseInt(exp['Impression']) || 0;
      const newFollowers = parseInt(exp['Nuovi Followers']) || 0;
      const followers = parseInt(exp['Tot. Followers']) || 0;
      
      // Calculate engagement rate for current week
      const currentEngagementRate = membersReached > 0 ? (engagement / membersReached) * 100 : 0;
      
      // Calculate changes
      const profileViewsChange = calculateChange(profileViews, data, index, 'Profile views 90d');
      const impressionsChange = calculateChange(impressions, data, index, 'Impression');
      
      // For engagement rate, we need to calculate the average engagement rate of previous weeks
      let engagementRateChange = null;
      if (index + 1 < data.length) {
        const previousRates = [];
        for (let i = index + 1; i < data.length; i++) {
          const prevEng = parseInt(data[i]['Engag.']) || 0;
          const prevReached = parseInt(data[i]['Members Reached']) || 0;
          if (prevReached > 0) {
            previousRates.push((prevEng / prevReached) * 100);
          }
        }
        if (previousRates.length > 0 && currentEngagementRate > 0) {
          const avgRate = previousRates.reduce((a, b) => a + b, 0) / previousRates.length;
          if (avgRate > 0) {
            engagementRateChange = Math.round(((currentEngagementRate - avgRate) / avgRate) * 100);
          }
        }
      }
      
      // For new followers growth rate
      let newFollowersChange = null;
      if (followers > 0) {
        const currentGrowthRate = (newFollowers / followers) * 100;
        
        if (index + 1 < data.length) {
          const previousGrowthRates = [];
          for (let i = index + 1; i < data.length; i++) {
            const prevNew = parseInt(data[i]['Nuovi Followers']) || 0;
            const prevTotal = parseInt(data[i]['Tot. Followers']) || 0;
            if (prevTotal > 0) {
              previousGrowthRates.push((prevNew / prevTotal) * 100);
            }
          }
          if (previousGrowthRates.length > 0) {
            const avgGrowthRate = previousGrowthRates.reduce((a, b) => a + b, 0) / previousGrowthRates.length;
            // Use absolute value only if avgGrowthRate is very close to 0 to avoid division issues
            const denominator = Math.abs(avgGrowthRate) < 0.01 ? 0.01 : avgGrowthRate;
            newFollowersChange = Math.round(((currentGrowthRate - avgGrowthRate) / Math.abs(denominator)) * 100);
          }
        }
      }
      
      // Calculate weighted composite score
      let totalWeight = 0;
      let weightedSum = 0;
      const breakdown = {};
      
      if (profileViewsChange !== null) {
        weightedSum += profileViewsChange * 0.40;
        totalWeight += 0.40;
        breakdown.profileViews = profileViewsChange;
      }
      
      if (engagementRateChange !== null) {
        weightedSum += engagementRateChange * 0.30;
        totalWeight += 0.30;
        breakdown.engagementRate = engagementRateChange;
      }
      
      if (newFollowersChange !== null) {
        weightedSum += newFollowersChange * 0.20;
        totalWeight += 0.20;
        breakdown.newFollowers = newFollowersChange;
      }
      
      if (impressionsChange !== null) {
        weightedSum += impressionsChange * 0.10;
        totalWeight += 0.10;
        breakdown.impressions = impressionsChange;
      }
      
      if (totalWeight === 0) return { score: null, breakdown: {} };
      
      const finalScore = Math.round(weightedSum / totalWeight);
      
      return { score: finalScore, breakdown };
    }
    
    // Get change class
    function getChangeClass(change) {
      if (change === null) return 'neutral';
      if (change >= 10) return 'positive';
      if (change <= -10) return 'negative';
      return 'neutral';
    }
    
    // Format change display
    function formatChange(change) {
      if (change === null) return '—';
      const sign = change > 0 ? '+' : '';
      return `${sign}${change}%`;
    }
    
    // Render Sintesi Tab
    function renderSintesi(data) {
      const container = document.getElementById('tab-sintesi');
      
      // Filter out experiments without hypothesis or with "- - -"
      const validExperiments = data.filter(exp => {
        const hypothesis = exp['Ipotesi'];
        return hypothesis && 
               hypothesis.trim() !== '' && 
               hypothesis.trim() !== '- - -' &&
               hypothesis.trim() !== '---' &&
               !hypothesis.trim().startsWith('- - -');
      });
      
      // Analyze experiments by type
      const typeAnalysis = {};
      
      validExperiments.forEach((exp) => {
        const index = data.indexOf(exp); // Get original index for growth calculation
        const type = exp['Tipo di esperimento'] || 'Altro';
        
        if (!typeAnalysis[type]) {
          typeAnalysis[type] = {
            experiments: []
          };
        }
        
        // Calculate growth score using original index
        const growthResult = calculateGrowthScore(data, index);
        
        typeAnalysis[type].experiments.push({
          week: exp['Week'],
          hypothesis: exp['Ipotesi'],
          learning: exp['Apprendimento'],
          score: growthResult.score,
          type: type
        });
      });
      
      // Get top 2 best hypotheses per type
      const bestPractices = [];
      Object.entries(typeAnalysis)
        .filter(([type]) => type !== 'Altro' && type !== '')
        .forEach(([type, analysis]) => {
          const validatedExperiments = analysis.experiments
            .filter(exp => exp.score !== null && exp.score >= 5)
            .sort((a, b) => b.score - a.score)
            .slice(0, 2);
          
          if (validatedExperiments.length > 0) {
            bestPractices.push({
              type: type,
              experiments: validatedExperiments
            });
          }
        });
      
      // Get all validated and invalidated hypotheses
      const allValidated = [];
      const allInvalidated = [];
      const allLearnings = [];
      
      validExperiments.forEach((exp) => {
        const index = data.indexOf(exp);
        const growthResult = calculateGrowthScore(data, index);
        
        if (growthResult.score !== null && growthResult.score >= 5) {
          allValidated.push({
            hypothesis: exp['Ipotesi'],
            score: growthResult.score,
            week: exp['Week'],
            type: exp['Tipo di esperimento']
          });
        } else if (growthResult.score !== null && growthResult.score <= -5) {
          allInvalidated.push({
            hypothesis: exp['Ipotesi'],
            score: growthResult.score,
            week: exp['Week'],
            type: exp['Tipo di esperimento']
          });
        }
        
        if (exp['Apprendimento'] && exp['Apprendimento'].trim() !== '') {
          allLearnings.push({
            learning: exp['Apprendimento'],
            week: exp['Week'],
            type: exp['Tipo di esperimento'],
            score: growthResult.score
          });
        }
      });
      
      // Sort
      allValidated.sort((a, b) => b.score - a.score);
      allInvalidated.sort((a, b) => a.score - b.score);
      
      const html = `
        <!-- Best Practices Card -->
        <div style="background: var(--primary-light); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-6); margin-bottom: var(--space-8);">
          <h2 style="font-size: var(--text-xl); font-weight: 600; color: var(--text-primary); margin: 0 0 var(--space-6) 0;">
            Best Practice
          </h2>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-5);">
            ${bestPractices.map(bp => `
              <div style="background: var(--gray-50); border-radius: var(--radius-md); padding: var(--space-4);">
                <div style="font-size: var(--text-xs); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-3);">
                  ${bp.type}
                </div>
                ${bp.experiments.map((exp, idx) => `
                  <div style="margin-bottom: ${idx < bp.experiments.length - 1 ? 'var(--space-4)' : '0'}; ${idx > 0 ? 'padding-top: var(--space-4); border-top: 1px solid var(--border-light);' : ''}">
                    <div style="display: flex; align-items: baseline; gap: var(--space-2); margin-bottom: var(--space-1);">
                      <span style="font-size: var(--text-sm); font-weight: 600; color: var(--success-green);">+${exp.score}%</span>
                      <span style="font-size: var(--text-xs); color: var(--text-tertiary);">${exp.week}</span>
                    </div>
                    <div style="font-size: var(--text-base); color: var(--text-primary); line-height: 1.5;">
                      ${exp.hypothesis || 'Nessuna ipotesi'}
                    </div>
                  </div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Hypotheses Title -->
        <h2 style="font-size: var(--text-xl); font-weight: 600; color: var(--text-primary); margin: 0 0 var(--space-5) 0;">
          Elenco delle Ipotesi
        </h2>
        
        <!-- Validated vs Invalidated -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-5); margin-bottom: var(--space-8);">
          
          <!-- Validated -->
          <div style="background: var(--primary-light); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-6);">
            <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--text-primary); margin: 0 0 var(--space-5) 0; display: flex; align-items: center; gap: var(--space-2);">
              <span style="color: var(--success-green);">✓</span>
              Ipotesi Validate
            </h3>
            
            ${allValidated.length > 0 ? `
              <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                ${allValidated.map(item => `
                  <div style="padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: baseline; gap: var(--space-2); margin-bottom: var(--space-2);">
                      <span style="font-size: var(--text-sm); font-weight: 600; color: var(--success-green);">+${item.score}%</span>
                      <span style="font-size: var(--text-xs); color: var(--text-tertiary);">${item.week}</span>
                      ${item.type ? `<span style="font-size: var(--text-xs); color: var(--text-secondary); background: var(--gray-200); padding: 2px var(--space-2); border-radius: var(--radius-sm);">${item.type}</span>` : ''}
                    </div>
                    <div style="font-size: var(--text-base); color: var(--text-primary); line-height: 1.5;">
                      ${item.hypothesis}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <p style="font-size: var(--text-sm); color: var(--text-secondary);">Nessuna ipotesi validata</p>
            `}
          </div>
          
          <!-- Invalidated -->
          <div style="background: var(--primary-light); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-6);">
            <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--text-primary); margin: 0 0 var(--space-5) 0; display: flex; align-items: center; gap: var(--space-2);">
              <span style="color: var(--error-red);">✗</span>
              Ipotesi Invalidate
            </h3>
            
            ${allInvalidated.length > 0 ? `
              <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                ${allInvalidated.map(item => `
                  <div style="padding-bottom: var(--space-4); border-bottom: 1px solid var(--border-light);">
                    <div style="display: flex; align-items: baseline; gap: var(--space-2); margin-bottom: var(--space-2);">
                      <span style="font-size: var(--text-sm); font-weight: 600; color: var(--error-red);">${item.score}%</span>
                      <span style="font-size: var(--text-xs); color: var(--text-tertiary);">${item.week}</span>
                      ${item.type ? `<span style="font-size: var(--text-xs); color: var(--text-secondary); background: var(--gray-200); padding: 2px var(--space-2); border-radius: var(--radius-sm);">${item.type}</span>` : ''}
                    </div>
                    <div style="font-size: var(--text-base); color: var(--text-primary); line-height: 1.5;">
                      ${item.hypothesis}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <p style="font-size: var(--text-sm); color: var(--text-secondary);">Nessuna ipotesi invalidata</p>
            `}
          </div>
          
        </div>
        
        <!-- Learnings -->
        <div style="background: var(--primary-light); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-6);">
          <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--text-primary); margin: 0 0 var(--space-5) 0;">
            Tutti gli Apprendimenti
          </h3>
          
          ${allLearnings.length > 0 ? `
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
              ${allLearnings.map(item => `
                <div style="padding: var(--space-3); background: var(--gray-50); border-radius: var(--radius-md);">
                  <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                    <span style="font-size: var(--text-xs); color: var(--text-tertiary);">${item.week}</span>
                    ${item.type ? `<span style="font-size: var(--text-xs); color: var(--text-secondary); background: var(--gray-200); padding: 2px var(--space-2); border-radius: var(--radius-sm);">${item.type}</span>` : ''}
                    ${item.score !== null ? `
                      <span style="font-size: var(--text-xs); font-weight: 600; color: ${item.score >= 5 ? 'var(--success-green)' : item.score <= -5 ? 'var(--error-red)' : 'var(--text-tertiary)'};">
                        ${item.score > 0 ? '+' : ''}${item.score}%
                      </span>
                    ` : ''}
                  </div>
                  <div style="font-size: var(--text-base); color: var(--text-primary); line-height: 1.5;">
                    ${item.learning}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <p style="font-size: var(--text-sm); color: var(--text-secondary);">Nessun apprendimento disponibile</p>
          `}
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Render Experiments Tab
    function renderExperiments(data) {
      const container = document.getElementById('tab-esperimenti');
      // Data is already ordered from most recent to oldest, no need to reverse
      
      const html = `
        <div class="experiments-grid">
          ${data.map((exp, index) => {
            const impressions = parseInt(exp['Impression']) || 0;
            const engagement = parseInt(exp['Engag.']) || 0;
            const membersReached = parseInt(exp['Members Reached']) || 0;
            const followers = parseInt(exp['Tot. Followers']) || 0;
            const newFollowers = parseInt(exp['Nuovi Followers']) || 0;
            const profileViews = parseInt(exp['Profile views 90d']) || 0;
            
            // Get engagement rate from CSV column
            const engagementRateStr = exp['% Engag. (2.6)'];
            const engagementRate = engagementRateStr && engagementRateStr !== '' 
              ? parseFloat(engagementRateStr.replace('%', '')).toFixed(1)
              : '0.0';
            const followerGrowthRate = followers > 0 ? ((newFollowers / followers) * 100).toFixed(2) : '0.00';
            
            // Calculate changes vs all previous weeks
            const impressionsChange = calculateChange(impressions, data, index, 'Impression');
            const engagementChange = calculateChange(engagement, data, index, 'Engag.');
            const followersChange = calculateChange(followers, data, index, 'Tot. Followers');
            const profileViewsChange = calculateChange(profileViews, data, index, 'Profile views 90d');
            
            // Calculate growth score
            const growthResult = calculateGrowthScore(data, index);
            const growthScore = growthResult.score;
            
            // Determine validation status based on growth score (±5% threshold)
            let validationStatus = 'Neutro';
            let validationClass = 'neutral';
            if (growthScore !== null) {
              if (growthScore >= 5) {
                validationStatus = 'Validato';
                validationClass = 'positive';
              } else if (growthScore <= -5) {
                validationStatus = 'Invalidato';
                validationClass = 'negative';
              }
            }
            
            const growthDisplay = growthScore !== null ? `${growthScore > 0 ? '+' : ''}${growthScore}%` : '—';
            
            // Build breakdown tooltip content
            let breakdownHTML = '';
            if (growthScore !== null && Object.keys(growthResult.breakdown).length > 0) {
              breakdownHTML = '<div class="growth-breakdown">';
              breakdownHTML += '<div class="growth-breakdown__title">Composizione Crescita:</div>';
              
              if (growthResult.breakdown.profileViews !== undefined) {
                breakdownHTML += `<div class="growth-breakdown__item">
                  <span class="growth-breakdown__label">Profile Views</span>
                  <span class="growth-breakdown__value">${growthResult.breakdown.profileViews > 0 ? '+' : ''}${growthResult.breakdown.profileViews}%</span>
                  <span class="growth-breakdown__weight">× 40%</span>
                </div>`;
              }
              
              if (growthResult.breakdown.engagementRate !== undefined) {
                breakdownHTML += `<div class="growth-breakdown__item">
                  <span class="growth-breakdown__label">Engagement Rate</span>
                  <span class="growth-breakdown__value">${growthResult.breakdown.engagementRate > 0 ? '+' : ''}${growthResult.breakdown.engagementRate}%</span>
                  <span class="growth-breakdown__weight">× 30%</span>
                </div>`;
              }
              
              if (growthResult.breakdown.newFollowers !== undefined) {
                breakdownHTML += `<div class="growth-breakdown__item">
                  <span class="growth-breakdown__label">Follower Growth Rate</span>
                  <span class="growth-breakdown__value">${growthResult.breakdown.newFollowers > 0 ? '+' : ''}${growthResult.breakdown.newFollowers}%</span>
                  <span class="growth-breakdown__weight">× 20%</span>
                </div>`;
              }
              
              if (growthResult.breakdown.impressions !== undefined) {
                breakdownHTML += `<div class="growth-breakdown__item">
                  <span class="growth-breakdown__label">Impressions</span>
                  <span class="growth-breakdown__value">${growthResult.breakdown.impressions > 0 ? '+' : ''}${growthResult.breakdown.impressions}%</span>
                  <span class="growth-breakdown__weight">× 10%</span>
                </div>`;
              }
              
              breakdownHTML += '</div>';
            }
            
            return `
              <div class="experiment-card">
                <div class="experiment-card__header">
                  <div class="experiment-card__date">${exp['Week']}</div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    ${exp['Tipo di esperimento'] ? `<div class="experiment-card__category">${exp['Tipo di esperimento']}</div>` : ''}
                    <div class="experiment-card__validation-wrapper">
                      <div class="experiment-card__validation experiment-card__validation--${validationClass}">
                        ${validationStatus} ${growthDisplay}
                        ${growthScore !== null ? '<span class="validation-info-icon">ⓘ</span>' : ''}
                      </div>
                      ${growthScore !== null ? `<div class="validation-tooltip">${breakdownHTML}</div>` : ''}
                    </div>
                  </div>
                </div>
                
                ${exp['Ipotesi'] ? `
                  <div class="experiment-card__section-title">Ipotesi</div>
                  <div class="experiment-card__hypothesis">
                    ${exp['Ipotesi']}
                  </div>
                ` : ''}
                
                ${exp['Apprendimento'] ? `
                  <div class="experiment-card__section-title">Apprendimento</div>
                  <div class="experiment-card__learning">
                    ${exp['Apprendimento']}
                  </div>
                ` : ''}
                
                <div class="metrics-grid">
                  <div class="metric-item">
                    <div class="metric-item__label">Profilo Views</div>
                    <div class="metric-item__value">
                      <div class="metric-item__number">${profileViews}</div>
                      <div class="metric-item__change metric-item__change--${getChangeClass(profileViewsChange)}">
                        ${formatChange(profileViewsChange)}
                      </div>
                    </div>
                  </div>
                  
                  <div class="metric-item">
                    <div class="metric-item__label">Impressioni</div>
                    <div class="metric-item__value">
                      <div class="metric-item__number">${impressions.toLocaleString()}</div>
                      <div class="metric-item__change metric-item__change--${getChangeClass(impressionsChange)}">
                        ${formatChange(impressionsChange)}
                      </div>
                    </div>
                  </div>
                  
                  <div class="metric-item">
                    <div class="metric-item__label">Engagement</div>
                    <div class="metric-item__value">
                      <div class="metric-item__number">${engagement}</div>
                      <div class="metric-item__change metric-item__change--${getChangeClass(engagementChange)}">
                        ${formatChange(engagementChange)}
                      </div>
                    </div>
                  </div>
                  
                  <div class="metric-item">
                    <div class="metric-item__label">Followers</div>
                    <div class="metric-item__value">
                      <div class="metric-item__number">${followers.toLocaleString()}</div>
                      <div class="metric-item__change metric-item__change--${getChangeClass(followersChange)}">
                        ${formatChange(followersChange)}
                      </div>
                    </div>
                  </div>
                  
                  <div class="metric-item">
                    <div class="metric-item__label">% Engagement</div>
                    <div class="metric-item__value">
                      <div class="metric-item__number">${engagementRate}%</div>
                    </div>
                  </div>
                  
                  <div class="metric-item">
                    <div class="metric-item__label">Nuovi Followers</div>
                    <div class="metric-item__value">
                      <div class="metric-item__number">${newFollowers > 0 ? '+' : ''}${newFollowers}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
      
      // Update count badge
      document.getElementById('experiments-count').textContent = data.length;
    }
    
    // Render Dati Tab
    function renderDati(data) {
      const container = document.getElementById('tab-dati');
      
      // Define columns to display (exclude Tipo di esperimento, Ipotesi, Apprendimento)
      const excludedColumns = ['Tipo di esperimento', 'Ipotesi', 'Apprendimento'];
      const allColumns = Object.keys(data[0] || {});
      const displayColumns = allColumns.filter(col => !excludedColumns.includes(col));
      
      // Columns that should show the LAST value (most recent)
      const lastValueColumns = ['Tot. Followers', 'Tot. Iscritti NL'];
      
      // Columns that should show AVERAGE
      const averageColumns = ['Profile views 90d'];
      
      // Calculate totals/averages for first row
      const summaryRow = {};
      displayColumns.forEach(col => {
        if (col === 'Week') {
          summaryRow[col] = 'TOTALE/MEDIA';
          return;
        }
        
        // Show last value for specific columns
        if (lastValueColumns.includes(col)) {
          const lastValue = data[0][col];
          if (lastValue && lastValue !== '') {
            const num = parseInt(lastValue);
            summaryRow[col] = isNaN(num) ? lastValue : num.toLocaleString();
          } else {
            summaryRow[col] = '—';
          }
          return;
        }
        
        const values = data.map(d => {
          const val = d[col];
          if (col.includes('%')) {
            // Parse percentage
            const num = parseFloat(String(val).replace('%', ''));
            return isNaN(num) ? null : num;
          }
          const num = parseInt(val);
          return isNaN(num) ? null : num;
        }).filter(v => v !== null);
        
        if (values.length === 0) {
          summaryRow[col] = '—';
        } else if (col.includes('%') || averageColumns.includes(col)) {
          // Average for percentages and specific columns
          const avg = values.reduce((a, b) => a + b, 0) / values.length;
          summaryRow[col] = col.includes('%') 
            ? avg.toFixed(2) + '%'
            : Math.round(avg).toLocaleString();
        } else {
          // Sum for counts
          const sum = values.reduce((a, b) => a + b, 0);
          summaryRow[col] = sum.toLocaleString();
        }
      });
      
      const html = `
        <div class="data-table-container">
          <div class="data-table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  ${displayColumns.map(col => `<th>${col}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                <!-- Summary Row -->
                <tr class="summary-row">
                  ${displayColumns.map(col => `
                    <td class="${col === 'Week' ? 'text' : 'number'}">
                      ${summaryRow[col]}
                    </td>
                  `).join('')}
                </tr>
                
                <!-- Data Rows -->
                ${data.map(row => `
                  <tr>
                    ${displayColumns.map(col => {
                      let value = row[col] || '—';
                      const isNumber = !isNaN(parseInt(value)) || value.includes('%');
                      return `<td class="${isNumber ? 'number' : 'text'}">${value}</td>`;
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    // Calculate median
    function calculateMedian(values) {
      const sorted = [...values].filter(v => v !== 0 && !isNaN(v)).sort((a, b) => a - b);
      if (sorted.length === 0) return 0;
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 === 0 
        ? (sorted[mid - 1] + sorted[mid]) / 2 
        : sorted[mid];
    }
    
    // Render Trend Tab
    function renderTrend(data) {
      const container = document.getElementById('tab-trend');
      
      // Use all available data for charts
      const allData = data;
      
      const html = `
        <div class="chart-container">
          <h3 class="chart-title">Followers/settimana</h3>
          <canvas id="chart-followers"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 class="chart-title">Persone Raggiunte/settimana</h3>
          <canvas id="chart-members-reached"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 class="chart-title">Visualizzazione dei post/settimana</h3>
          <canvas id="chart-impressions"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 class="chart-title">Visite al profilo (ultimi 30 giorni)</h3>
          <canvas id="chart-profile-views"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 class="chart-title">% Engagement (persone raggiunte/interazioni)</h3>
          <canvas id="chart-engagement-rate"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 class="chart-title">% Crescita Followers/settimana</h3>
          <canvas id="chart-follower-growth-rate"></canvas>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Prepare data in chronological order (oldest to newest)
      const chronologicalData = [...allData].reverse();
      
      // Followers Chart (actually New Followers per week)
      const followersData = chronologicalData.map(d => parseInt(d['Nuovi Followers']) || 0);
      const followersMedian = calculateMedian(followersData);
      
      const followersCtx = document.getElementById('chart-followers').getContext('2d');
      new Chart(followersCtx, {
        type: 'bar',
        data: {
          labels: chronologicalData.map(d => d['Week']),
          datasets: [
            {
              label: 'Nuovi Followers',
              data: followersData,
              backgroundColor: chronologicalData.map(d => {
                const val = parseInt(d['Nuovi Followers']) || 0;
                return val > 0 ? '#0A66C2' : val < 0 ? '#EF4444' : '#6B6B6B';
              }),
              borderRadius: 6,
              order: 2
            },
            {
              label: 'Mediana',
              data: Array(chronologicalData.length).fill(followersMedian),
              type: 'line',
              borderColor: '#60A5FA',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#E8E8E3' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      // Members Reached Chart
      const membersReachedData = chronologicalData.map(d => parseInt(d['Members Reached']) || 0);
      const membersReachedMedian = calculateMedian(membersReachedData);
      
      const membersReachedCtx = document.getElementById('chart-members-reached').getContext('2d');
      new Chart(membersReachedCtx, {
        type: 'bar',
        data: {
          labels: chronologicalData.map(d => d['Week']),
          datasets: [
            {
              label: 'Persone Raggiunte',
              data: membersReachedData,
              backgroundColor: '#F59E0B',
              borderRadius: 6,
              order: 2
            },
            {
              label: 'Mediana',
              data: Array(chronologicalData.length).fill(membersReachedMedian),
              type: 'line',
              borderColor: '#60A5FA',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#E8E8E3' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      // Impressions Chart
      const impressionsData = chronologicalData.map(d => parseInt(d['Impression']) || 0);
      const impressionsMedian = calculateMedian(impressionsData);
      
      const impressionsCtx = document.getElementById('chart-impressions').getContext('2d');
      new Chart(impressionsCtx, {
        type: 'bar',
        data: {
          labels: chronologicalData.map(d => d['Week']),
          datasets: [
            {
              label: 'Visualizzazioni',
              data: impressionsData,
              backgroundColor: '#3B82F6',
              borderRadius: 6,
              order: 2
            },
            {
              label: 'Mediana',
              data: Array(chronologicalData.length).fill(impressionsMedian),
              type: 'line',
              borderColor: '#60A5FA',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#E8E8E3' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      // Profile Views Chart
      const profileViewsData = chronologicalData.map(d => parseInt(d['Profile views 90d']) || 0);
      const profileViewsMedian = calculateMedian(profileViewsData);
      
      const profileViewsCtx = document.getElementById('chart-profile-views').getContext('2d');
      new Chart(profileViewsCtx, {
        type: 'line',
        data: {
          labels: chronologicalData.map(d => d['Week']),
          datasets: [
            {
              label: 'Profile Views',
              data: profileViewsData,
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              order: 2
            },
            {
              label: 'Mediana',
              data: Array(chronologicalData.length).fill(profileViewsMedian),
              borderColor: '#60A5FA',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#E8E8E3' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      // Engagement Rate Chart
      const engagementRateData = chronologicalData.map(d => {
        const rateStr = d['% Engag. (2.6)'];
        if (!rateStr || rateStr === '') return 0;
        const rate = parseFloat(rateStr.replace('%', ''));
        return isNaN(rate) ? 0 : rate;
      });
      const engagementRateMedian = calculateMedian(engagementRateData);
      
      const engagementRateCtx = document.getElementById('chart-engagement-rate').getContext('2d');
      new Chart(engagementRateCtx, {
        type: 'line',
        data: {
          labels: chronologicalData.map(d => d['Week']),
          datasets: [
            {
              label: '% Engagement',
              data: engagementRateData,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              order: 2
            },
            {
              label: 'Mediana',
              data: Array(chronologicalData.length).fill(engagementRateMedian),
              borderColor: '#60A5FA',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#E8E8E3' },
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
      
      // Follower Growth Rate Chart
      const followerGrowthRateData = chronologicalData.map(d => {
        const newFollowers = parseInt(d['Nuovi Followers']) || 0;
        const totalFollowers = parseInt(d['Tot. Followers']) || 0;
        if (totalFollowers === 0) return 0;
        return parseFloat(((newFollowers / totalFollowers) * 100).toFixed(2));
      });
      const followerGrowthRateMedian = calculateMedian(followerGrowthRateData);
      
      const followerGrowthRateCtx = document.getElementById('chart-follower-growth-rate').getContext('2d');
      new Chart(followerGrowthRateCtx, {
        type: 'line',
        data: {
          labels: chronologicalData.map(d => d['Week']),
          datasets: [
            {
              label: '% Crescita Followers',
              data: followerGrowthRateData,
              borderColor: '#EF4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              order: 2
            },
            {
              label: 'Mediana',
              data: Array(chronologicalData.length).fill(followerGrowthRateMedian),
              borderColor: '#60A5FA',
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#E8E8E3' },
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Load data
    async function loadData() {
      try {
        const response = await fetch(SHEET_URL);
        const csvText = await response.text();
        experimentsData = parseCSV(csvText);
        
        renderSintesi(experimentsData);
        renderExperiments(experimentsData);
        renderDati(experimentsData);
        renderTrend(experimentsData);
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('tab-dati').innerHTML = `
          <div class="empty-state">
            <div class="empty-state__title">Errore nel caricamento dei dati</div>
            <p>Impossibile caricare i dati dal Google Sheet. Riprova più tardi.</p>
          </div>
        `;
        document.getElementById('tab-sintesi').innerHTML = `
          <div class="empty-state">
            <div class="empty-state__title">Errore nel caricamento dei dati</div>
            <p>Impossibile caricare i dati dal Google Sheet. Riprova più tardi.</p>
          </div>
        `;
        document.getElementById('tab-esperimenti').innerHTML = `
          <div class="empty-state">
            <div class="empty-state__title">Errore nel caricamento dei dati</div>
            <p>Impossibile caricare i dati dal Google Sheet. Riprova più tardi.</p>
          </div>
        `;
      }
    }
    
    // Tab Navigation
    document.querySelectorAll('.sidebar-nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const tabName = item.dataset.tab;
        
        // Update active nav item
        document.querySelectorAll('.sidebar-nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // Update active tab content
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Update topbar title
        let title = '';
        if (tabName === 'sintesi' && experimentsData) {
          // Count experiments with valid hypotheses for sintesi
          const validExperiments = experimentsData.filter(exp => {
            const hypothesis = exp['Ipotesi'];
            return hypothesis && 
                   hypothesis.trim() !== '' && 
                   hypothesis.trim() !== '- - -' &&
                   hypothesis.trim() !== '---' &&
                   !hypothesis.trim().startsWith('- - -');
          });
          title = `Sintesi di ${validExperiments.length} esperimenti`;
        } else {
          const titles = {
            'sintesi': 'Sintesi',
            'esperimenti': 'Esperimenti',
            'dati': 'Dati',
            'trend': 'Trend'
          };
          title = titles[tabName];
        }
        document.getElementById('topbar-title').textContent = title;
      });
    });
    
    // Initialize
    loadData();
  </script>
</body>
</html>